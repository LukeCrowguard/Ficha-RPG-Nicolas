<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha D&D 5e - Oficial</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Open+Sans:wght@400;600;700&family=Cinzel:wght@700&display=swap');

        :root {
            --bg-body: #2c3e50;
            --bg-paper: #fdfbf6;
            --paper-texture: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            --text-main: #222;
            --text-muted: #666;
            --border-color: #aaa;
            --accent-color: #901212;
            --header-font: 'Cinzel', serif;
            --label-font: 'Libre Baskerville', serif;
            --body-font: 'Open Sans', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-body);
            font-family: var(--body-font);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Toolbar --- */
        .toolbar {
            width: 100%;
            max-width: 1100px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .btn {
            background: #eee; border: 1px solid #ccc; padding: 5px 10px; 
            cursor: pointer; font-size: 12px; border-radius: 3px; font-weight: bold;
            color: #333; transition: 0.2s;
        }
        .btn:hover { background: #ddd; }
        .btn-danger { background: #e74c3c; color: white; border-color: #c0392b; }
        .btn-danger:hover { background: #c0392b; }
        .btn-sm { padding: 2px 8px; font-size: 10px; margin-top: 5px; width: 100%; border-style: dashed;}

        .tabs { display: flex; gap: 10px; }
        .tab-btn {
            background: none; border: none; font-weight: bold; color: #777; 
            cursor: pointer; padding: 5px 0; border-bottom: 3px solid transparent;
        }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }

        /* --- Sheet Layout --- */
        .sheet {
            background-color: var(--bg-paper);
            background-image: var(--paper-texture);
            width: 100%;
            max-width: 1100px;
            min-height: 1400px;
            padding: 40px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            display: none;
            position: relative;
        }
        .sheet.active { display: block; }

        input, textarea, select {
            background: transparent; border: none; width: 100%;
            font-family: var(--body-font); color: var(--text-main);
        }
        input:focus, textarea:focus, select:focus { outline: none; background: rgba(0,0,0,0.05); }
        textarea { resize: none; }
        
        input.manual-override {
            background-color: #fffbe6;
            border-bottom: 1px dashed #e6c100 !important;
        }

        /* --- Global Styles --- */
        .label-sm { 
            font-family: var(--label-font); font-size: 8px; font-weight: bold; 
            text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; 
        }
        .box {
            border: 1px solid var(--border-color); border-radius: 5px;
            background: white; padding: 5px; position: relative;
        }

        /* --- Header --- */
        .header-main {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            align-items: stretch;
        }

        .char-image-box {
            width: 220px; 
            min-height: 200px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: #eee;
            background-size: cover;
            background-position: center top;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 11px;
            color: #777;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
            transition: opacity 0.2s;
        }
        .char-image-box:hover { opacity: 0.9; border-color: var(--accent-color); }
        
        .header-text-col {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .char-name-block {
            border: 1px solid var(--border-color); border-radius: 10px; padding: 10px 15px;
            display: flex; flex-direction: column-reverse; background: rgba(255,255,255,0.5);
        }
        .char-name-input { font-family: var(--header-font); font-size: 32px; border-bottom: 1px solid #ccc; padding: 5px; }

        .meta-grid {
            border: 1px solid var(--border-color); border-radius: 10px; padding: 15px;
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px 20px;
            background: rgba(255,255,255,0.5);
            flex-grow: 1;
        }
        .meta-field { display: flex; flex-direction: column-reverse; }
        .meta-field input, .meta-field select { border-bottom: 1px solid #aaa; font-size: 13px; padding: 2px 0; }

        /* --- 3 Column Layout --- */
        .sheet-body {
            display: grid;
            grid-template-columns: 32% 34% 32%;
            gap: 1%;
            align-items: start;
        }

        /* --- Col 1: Stats & Skills --- */
        .col-1 { display: flex; gap: 10px; }
        .stats-strip { width: 70px; display: flex; flex-direction: column; gap: 15px; }
        .skills-col { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }

        .ability-box {
            border: 1px solid var(--border-color); border-radius: 10px; text-align: center;
            background: white; position: relative; padding: 5px 0 15px 0;
            display: flex; flex-direction: column; align-items: center;
        }
        .ability-label { font-weight: bold; font-size: 9px; color: #555; margin-bottom: 2px; }
        
        .ability-score-big { 
            font-family: var(--body-font); font-size: 30px; width: 100%; text-align: center;
            border: none; background: transparent; margin-bottom: 5px;
        }
        .ability-mod-oval {
            width: 34px; height: 22px; 
            border: 1px solid var(--border-color); border-radius: 12px;
            background: white; 
            position: absolute; bottom: -11px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; justify-content: center; z-index: 2;
            font-size: 12px; font-weight: bold;
        }

        .insp-box { border: 1px solid var(--border-color); border-radius: 10px; padding: 5px; display: flex; align-items: center; justify-content: space-between; background: white; }
        .prof-box { border: 1px solid var(--border-color); border-radius: 10px; padding: 5px; display: flex; align-items: center; justify-content: space-between; background: white; margin-bottom: 10px;}
        .prof-val { font-size: 16px; font-weight: bold; border: 1px solid #555; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 5px; }

        .skill-container { border: 1px solid var(--border-color); border-radius: 10px; padding: 10px; background: white; font-size: 11px; }
        .skill-row { display: flex; align-items: center; border-bottom: 1px solid #eee; padding: 2px 0; }
        .skill-mod { width: 20px; text-align: center; color: #555; margin: 0 5px; }
        .skill-name { flex-grow: 1; }
        .skill-attr { color: #999; font-size: 9px; }
        
        .marker { width: 10px; height: 10px; border: 1px solid #777; border-radius: 50%; cursor: pointer; background: #fff; }
        .marker[data-val="1"] { background: #333; }
        .marker[data-val="2"] { background: #333; box-shadow: 0 0 0 2px #fff, 0 0 0 3px #333; }

        .passive-perc { border: 1px solid var(--border-color); border-radius: 20px; padding: 5px 15px; margin-top: 10px; display: flex; align-items: center; background: white; font-size: 11px; color: #555; }
        .langs-box { border: 1px solid var(--border-color); border-radius: 10px; padding: 10px; background: white; margin-top: 10px; flex-grow: 1; min-height: 150px; display: flex; flex-direction: column; }

        /* --- Col 2: Combat --- */
        .col-2 { display: flex; flex-direction: column; gap: 10px; padding: 0 5px; }
        
        .combat-header { display: flex; gap: 5px; background: #eee; border-radius: 10px; padding: 5px; border: 1px solid #ccc; }
        .combat-stat { flex: 1; display: flex; flex-direction: column; align-items: center; background: white; border: 1px solid #ccc; border-radius: 5px; padding: 5px; }
        .combat-val { font-size: 24px; font-weight: bold; text-align: center; font-family: var(--header-font); }

        .hp-box { border: 1px solid var(--border-color); border-radius: 10px; background: white; padding: 5px 10px; }
        .hp-top { display: flex; justify-content: space-between; font-size: 10px; color: #777; margin-bottom: 2px; }
        .hp-big { font-size: 30px; text-align: center; width: 100%; font-family: var(--header-font); }

        .hd-ds-row { display: flex; gap: 10px; }
        .ds-row { display: flex; justify-content: space-between; align-items: center; font-size: 10px; margin: 2px 0; }
        .ds-bubbles { display: flex; gap: 3px; }

        .attacks-box { border: 1px solid var(--border-color); border-radius: 10px; background: white; flex-grow: 0; min-height: 250px; padding: 5px; display: flex; flex-direction: column; }
        .atk-table { width: 100%; font-size: 11px; border-collapse: collapse; }
        .atk-table th { text-align: left; color: #777; border-bottom: 1px solid #ccc; font-size: 9px; padding: 2px; }
        .atk-table td { padding: 4px 0; border-bottom: 1px solid #eee; }
        .atk-input { background: #fafafa; padding: 3px; border-radius: 3px; }

        .equip-row { display: flex; gap: 5px; margin-top: 10px; flex-grow: 1; }
        .coins-col { width: 50px; display: flex; flex-direction: column; gap: 3px; }
        .coin-box { border: 1px solid var(--border-color); border-radius: 5px; padding: 2px; background: #fdfdfd; display: flex; flex-direction: column; align-items: center; }
        .coin-label { font-size: 8px; font-weight: bold; color: #555; }
        .coin-val { font-size: 12px; text-align: center; width: 100%; }

        /* --- Col 3: Traits --- */
        .col-3 { display: flex; flex-direction: column; gap: 10px; }
        .trait-box { border: 1px solid var(--border-color); border-radius: 10px; background: white; padding: 10px; min-height: 80px; position: relative; }
        .trait-title { position: absolute; top: -8px; left: 10px; background: white; padding: 0 5px; font-weight: bold; font-size: 10px; text-transform: uppercase; color: #333; letter-spacing: 1px;}
        .trait-text { font-size: 11px; height: 100%; width: 100%; margin-top: 5px; line-height: 1.4; }

        .features-box { flex-grow: 1; min-height: 300px; border: 1px solid var(--border-color); border-radius: 10px; background: white; padding: 10px; position: relative; }

        /* --- Spells Page --- */
        .spells-header { background: #333; color: white; padding: 15px; border-radius: 5px; display: flex; gap: 10px; text-align: center; margin-bottom: 20px;}
        .spell-stat { flex: 1; border-right: 1px solid #555; }
        .spell-stat:last-child { border: none; }
        
        .spell-stat-input {
            font-size: 24px; font-weight: bold; color: white; text-align: center;
            border: none; border-bottom: 1px solid #777;
        }
        .spell-stat-input:focus { background: rgba(255,255,255,0.1); }

        .spell-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .spell-lvl-box { border: 1px solid #ccc; border-radius: 5px; background: white; overflow: hidden; display: flex; flex-direction: column; }
        .spell-lvl-head { background: #eee; padding: 5px 10px; font-weight: bold; font-family: var(--header-font); font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        /* New Slot Config Styles */
        .slots-config { display: flex; align-items: center; gap: 8px; }
        .slot-input-sm { width: 35px; text-align: center; border: 1px solid #999; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .slot-bubbles { display: flex; gap: 3px; }
        .slot-bubble { width: 14px; height: 14px; border: 1px solid #555; border-radius: 50%; cursor: pointer; background: white; }
        .slot-bubble.used { background: var(--accent-color); border-color: var(--accent-color); }
        .label-xs { font-size: 10px; font-weight: bold; color: #555; text-transform: uppercase; }

        .spell-list { padding: 5px; flex-grow: 1; }
        .spell-row { display: flex; align-items: center; border-bottom: 1px dotted #ddd; padding: 2px 0; }

        @media print {
            .toolbar { display: none; }
            .sheet { display: block; margin: 0; box-shadow: none; padding: 0; page-break-after: always; width: 100%; max-width: none; }
            body { background: white; padding: 0; }
        }
    </style>
</head>
<body>

<div class="toolbar">
    <div style="display: flex; align-items: center; gap: 15px;">
        <span style="font-weight: bold; color: var(--accent-color); font-family: var(--header-font);">D&D 5e</span>
        <div class="tabs">
            <button class="tab-btn active" onclick="showPage('page1')">Principal</button>
            <button class="tab-btn" onclick="showPage('page2')">Bio</button>
            <button class="tab-btn" onclick="showPage('page3')">Magias</button>
        </div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn" onclick="resetShort()">Descanso Curto</button>
        <button class="btn btn-danger" onclick="resetLong()">Descanso Longo</button>
        <button class="btn" onclick="manualSave()">ðŸ’¾ Salvar</button>
        <button class="btn" onclick="saveJSON()">ðŸ“¥ Exportar</button>
        <button class="btn" onclick="document.getElementById('fileUp').click()">ðŸ“‚ Importar</button>
        <input type="file" id="fileUp" style="display:none" onchange="loadJSON(this)">
    </div>
</div>

<!-- ================= PAGE 1 ================= -->
<div id="page1" class="sheet active">
    <div class="header-main">
        <div class="char-image-box" id="charImageContainer" onclick="document.getElementById('imgInput').click()">
            <span id="imgPlaceholder">Imagem do Personagem<br>(Clique para alterar)</span>
            <input type="file" id="imgInput" style="display: none;" accept="image/*" onchange="uploadImage(this)">
        </div>
        <div class="header-text-col">
            <div class="char-name-block">
                <input type="text" class="char-name-input sync-name" id="charName">
                <div class="label-sm">Nome do Personagem</div>
            </div>
            <div class="meta-grid">
                <div class="meta-field"><input type="text" id="classLevel" onchange="recalc()"><div class="label-sm">Classe & NÃ­vel</div></div>
                <div class="meta-field"><input type="text" id="background"><div class="label-sm">Antecedentes</div></div>
                <div class="meta-field"><input type="text" id="player"><div class="label-sm">Jogador</div></div>
                <div class="meta-field"><input type="text" id="race"><div class="label-sm">RaÃ§a</div></div>
                <div class="meta-field">
                    <select id="alignment">
                        <option value=""></option><option>LB</option><option>NB</option><option>CB</option>
                        <option>LN</option><option>N</option><option>CN</option><option>LM</option><option>NM</option><option>CM</option>
                    </select>
                    <div class="label-sm">TendÃªncia</div>
                </div>
                <div class="meta-field"><input type="text" id="xp"><div class="label-sm">XP</div></div>
            </div>
        </div>
    </div>

    <div class="sheet-body">
        <div class="col-1">
            <div class="stats-strip" id="statsStrip"></div>
            <div class="skills-col">
                <div class="insp-box">
                    <input type="number" id="inspiration" style="width: 40px; height: 35px; font-size: 20px; font-weight: bold; text-align: center; border: 1px solid #777; border-radius: 5px;" placeholder="0">
                    <div class="label-sm" style="margin-left: 5px;">InspiraÃ§Ã£o</div>
                </div>
                <div class="prof-box">
                    <div class="prof-val" id="profBonus">+2</div>
                    <div class="label-sm">BÃ´nus de<br>ProficiÃªncia</div>
                </div>
                <div class="skill-container">
                    <div class="label-sm" style="text-align: center; margin-bottom: 5px;">Testes de ResistÃªncia</div>
                    <div id="savesList"></div>
                </div>
                <div class="skill-container">
                    <div class="label-sm" style="text-align: center; margin-bottom: 5px;">PerÃ­cias</div>
                    <div id="skillsList"></div>
                </div>
                <div class="passive-perc">
                    <span style="font-weight: bold; font-size: 14px; margin-right: 10px;" id="passivePerc">10</span>
                    Sabedoria Passiva (PercepÃ§Ã£o)
                </div>
                <div class="langs-box">
                    <div class="label-sm">Outras ProficiÃªncias & Idiomas</div>
                    <textarea id="langs" style="margin-top: 5px; height: 100%;"></textarea>
                </div>
            </div>
        </div>

        <div class="col-2">
            <div class="combat-header">
                <div class="combat-stat"><input type="text" class="combat-val" id="ac" value="10"><div class="label-sm">Classe Armadura</div></div>
                <div class="combat-stat"><input type="text" class="combat-val" id="init" value="0" oninput="toggleManual('init')"><div class="label-sm">Iniciativa</div></div>
                <div class="combat-stat"><input type="text" class="combat-val" id="speed" value="9m"><div class="label-sm">Deslocamento</div></div>
            </div>
            <div class="hp-box">
                <div class="hp-top"><span>Pontos de Vida MÃ¡ximos</span><input type="number" id="hpMax" style="width: 50px; text-align: right; border-bottom: 1px solid #ccc;"></div>
                <input type="number" id="hpCurrent" class="hp-big" placeholder="Atual">
                <div class="label-sm" style="text-align: center;">Pontos de Vida Atuais</div>
            </div>
            <div class="hp-box">
                <input type="number" id="hpTemp" class="hp-big" placeholder="Temp" style="font-size: 20px;">
                <div class="label-sm" style="text-align: center;">Pontos de Vida TemporÃ¡rios</div>
            </div>
            <div class="hd-ds-row">
                <div class="hp-box" style="flex: 1;">
                    <div class="label-sm">Dados de Vida</div>
                    <div style="display: flex; align-items: center; justify-content: center; margin-top: 5px;">
                        <input type="text" id="hdTotal" placeholder="Total" style="width: 45px; text-align: center; border-right: 1px solid #ccc; margin-right: 5px; font-size:14px;">
                        <input type="number" id="hdCurrent" placeholder="Atuais" style="font-size: 16px; text-align: center; width:45px;">
                    </div>
                </div>
                <div class="hp-box" style="flex: 1;">
                    <div class="label-sm" style="text-align: center; margin-bottom: 2px;">Testes de Morte</div>
                    <div class="ds-row"><span>Sucessos</span><div class="ds-bubbles"><div class="marker" id="dsS1" onclick="toggleMarker(this, 1)"></div><div class="marker" id="dsS2" onclick="toggleMarker(this, 1)"></div><div class="marker" id="dsS3" onclick="toggleMarker(this, 1)"></div></div></div>
                    <div class="ds-row"><span>Falhas</span><div class="ds-bubbles"><div class="marker" id="dsF1" onclick="toggleMarker(this, 1)"></div><div class="marker" id="dsF2" onclick="toggleMarker(this, 1)"></div><div class="marker" id="dsF3" onclick="toggleMarker(this, 1)"></div></div></div>
                </div>
            </div>
            <div class="attacks-box">
                <div class="label-sm" style="text-align: center; margin-bottom: 5px;">Ataques e Magias</div>
                <table class="atk-table">
                    <thead><tr><th width="40%">Nome</th><th width="20%">BÃ´nus</th><th width="40%">Dano/Tipo</th></tr></thead>
                    <tbody id="atkRows"></tbody>
                </table>
                <button class="btn btn-sm" onclick="addAtkRow()">+ Adicionar Arma</button>
                <textarea id="atkNotes" style="flex-grow: 1; border-top: 1px solid #eee; margin-top: 5px; padding: 5px;" placeholder="Notas..."></textarea>
            </div>
            <div class="equip-row">
                <div class="coins-col">
                    <div class="coin-box"><div class="coin-label">PC</div><input type="text" id="cp" class="coin-val"></div>
                    <div class="coin-box"><div class="coin-label">PP</div><input type="text" id="sp" class="coin-val"></div>
                    <div class="coin-box"><div class="coin-label">PE</div><input type="text" id="ep" class="coin-val"></div>
                    <div class="coin-box"><div class="coin-label" style="color: #d4ac0d;">PO</div><input type="text" id="gp" class="coin-val"></div>
                    <div class="coin-box"><div class="coin-label">PL</div><input type="text" id="pp" class="coin-val"></div>
                </div>
                <div class="box" style="flex-grow: 1;">
                    <div class="label-sm" style="text-align: center;">Equipamento</div>
                    <textarea id="equip" style="height: 100%; min-height: 150px;"></textarea>
                </div>
            </div>
        </div>

        <div class="col-3">
            <div class="trait-box"><div class="trait-title">TraÃ§os de Personalidade</div><textarea id="traits" class="trait-text"></textarea></div>
            <div class="trait-box"><div class="trait-title">Ideais</div><textarea id="ideals" class="trait-text"></textarea></div>
            <div class="trait-box"><div class="trait-title">VÃ­nculos</div><textarea id="bonds" class="trait-text"></textarea></div>
            <div class="trait-box"><div class="trait-title">Fraquezas</div><textarea id="flaws" class="trait-text"></textarea></div>
            <div class="features-box"><div class="trait-title">CaracterÃ­sticas e Talentos</div><textarea id="features" class="trait-text" style="height: 100%;"></textarea></div>
        </div>
    </div>
</div>

<!-- ================= PAGE 2: BIO ================= -->
<div id="page2" class="sheet">
    <div class="header-main">
        <div class="char-name-block"><input type="text" class="char-name-input sync-name"><div class="label-sm">Nome do Personagem</div></div>
        <div style="display: flex; align-items: flex-end; padding-bottom: 10px; font-size: 24px; font-family: var(--header-font);">Biografia</div>
    </div>
    <div class="meta-grid" style="grid-template-columns: repeat(6, 1fr); margin-bottom: 20px;">
        <div class="meta-field"><input type="text" id="age"><div class="label-sm">Idade</div></div>
        <div class="meta-field"><input type="text" id="height"><div class="label-sm">Altura</div></div>
        <div class="meta-field"><input type="text" id="weight"><div class="label-sm">Peso</div></div>
        <div class="meta-field"><input type="text" id="eyes"><div class="label-sm">Olhos</div></div>
        <div class="meta-field"><input type="text" id="skin"><div class="label-sm">Pele</div></div>
        <div class="meta-field"><input type="text" id="hair"><div class="label-sm">Cabelo</div></div>
    </div>
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <div class="box" style="padding: 15px;"><div class="label-sm">HistÃ³ria do Personagem</div><textarea id="backstory" style="height: 400px; margin-top: 10px;"></textarea></div>
            <div class="box" style="padding: 15px;"><div class="label-sm">Aliados & OrganizaÃ§Ãµes</div><textarea id="allies" style="height: 150px; margin-top: 10px;"></textarea></div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 20px;">
             <div class="box" style="padding: 15px;"><div class="label-sm">AparÃªncia</div><textarea id="appearance" style="height: 150px; margin-top: 10px;"></textarea></div>
             <div class="box" style="padding: 15px;"><div class="label-sm">Tesouro Adicional</div><textarea id="treasure" style="height: 150px; margin-top: 10px;"></textarea></div>
        </div>
    </div>
</div>

<!-- ================= PAGE 3: SPELLS ================= -->
<div id="page3" class="sheet">
    <div class="header-main">
        <div class="char-name-block"><input type="text" class="char-name-input sync-name"><div class="label-sm">Nome do Personagem</div></div>
        <div style="display: flex; align-items: flex-end; padding-bottom: 10px; font-size: 24px; font-family: var(--header-font);">GrimÃ³rio</div>
    </div>
    <div class="spells-header">
        <div class="spell-stat"><input id="spellClass" style="color: white; border-bottom: 1px solid white; text-align: center; font-size: 16px;" placeholder="Classe"><div class="label-sm" style="color: #aaa;">Classe Conjuradora</div></div>
        <div class="spell-stat">
            <select id="spellAbility" onchange="recalc()" style="color: white; border-bottom: 1px solid white; text-align: center; font-size: 16px;">
                <option value="int">InteligÃªncia</option><option value="wis">Sabedoria</option><option value="cha">Carisma</option>
            </select><div class="label-sm" style="color: #aaa;">Atributo Chave</div>
        </div>
        <div class="spell-stat"><input type="number" id="spellDC" class="spell-stat-input" value="10" oninput="toggleManual('spellDC')"><div class="label-sm" style="color: #aaa;">CD ResistÃªncia</div></div>
        <div class="spell-stat"><input type="number" id="spellAtk" class="spell-stat-input" value="2" oninput="toggleManual('spellAtk')"><div class="label-sm" style="color: #aaa;">BÃ´nus Ataque</div></div>
    </div>
    <div class="spell-grid" id="spellContainer"></div>
</div>

<script>
    const attrs = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
    const attrNames = {str:'ForÃ§a', dex:'Destreza', con:'ConstituiÃ§Ã£o', int:'InteligÃªncia', wis:'Sabedoria', cha:'Carisma'};
    const skills = [
        {id:'acrob', name:'Acrobacia', at:'dex'}, {id:'animal', name:'Adestrar Animais', at:'wis'},
        {id:'arcana', name:'Arcanismo', at:'int'}, {id:'athlet', name:'Atletismo', at:'str'},
        {id:'perform', name:'AtuaÃ§Ã£o', at:'cha'}, {id:'decept', name:'EnganaÃ§Ã£o', at:'cha'},
        {id:'stealth', name:'Furtividade', at:'dex'}, {id:'history', name:'HistÃ³ria', at:'int'},
        {id:'intimid', name:'IntimidaÃ§Ã£o', at:'cha'}, {id:'insight', name:'IntuiÃ§Ã£o', at:'wis'},
        {id:'invest', name:'InvestigaÃ§Ã£o', at:'int'}, {id:'medicine', name:'Medicina', at:'wis'},
        {id:'nature', name:'Natureza', at:'int'}, {id:'percep', name:'PercepÃ§Ã£o', at:'wis'},
        {id:'persuas', name:'PersuasÃ£o', at:'cha'}, {id:'sleight', name:'PrestidigitaÃ§Ã£o', at:'dex'},
        {id:'religion', name:'ReligiÃ£o', at:'int'}, {id:'survival', name:'SobrevivÃªncia', at:'wis'}
    ];

    window.onload = function() {
        buildUI();
        loadLocal();
        recalc();
        setupEvents();
    };

    function buildUI() {
        const st = document.getElementById('statsStrip');
        attrs.forEach(a => {
            st.innerHTML += `<div class="ability-box"><div class="ability-label">${attrNames[a].toUpperCase()}</div><input type="number" class="ability-score-big" id="score_${a}" value="10" oninput="recalc(); saveLocal()"><div class="ability-mod-oval" id="mod_${a}">+0</div></div>`;
        });

        const sl = document.getElementById('savesList');
        attrs.forEach(a => {
            sl.innerHTML += `<div class="skill-row"><div class="marker" id="save_${a}" data-val="0" onclick="toggleMarker(this, 1)"></div><div class="skill-mod" id="saveVal_${a}">+0</div><div class="skill-name">${attrNames[a]}</div></div>`;
        });

        const skl = document.getElementById('skillsList');
        skills.forEach(s => {
            skl.innerHTML += `<div class="skill-row"><div class="marker" id="skill_${s.id}" data-val="0" onclick="toggleMarker(this, 2)"></div><div class="skill-mod" id="skillVal_${s.id}">+0</div><div class="skill-name">${s.name} <span class="skill-attr">(${s.at.substring(0,3).toUpperCase()})</span></div></div>`;
        });

        const atk = document.getElementById('atkRows');
        for(let i=0; i<5; i++) { addAtkRow(i); }

        const spc = document.getElementById('spellContainer');
        spc.innerHTML += `<div class="spell-lvl-box" id="spellBox0"><div class="spell-lvl-head">Truques (0)</div><div class="spell-list" id="spellList0">${Array(8).fill(0).map((_,i)=>`<div class="spell-row" id="row_0_${i}"><input id="cantrip${i}" style="font-size:11px;"></div>`).join('')}</div><button class="btn-sm" onclick="addSpellRow(0)">+ Adicionar</button></div>`;
        
        for(let i=1; i<=9; i++) {
            spc.innerHTML += `
            <div class="spell-lvl-box" id="spellBox${i}">
                <div class="spell-lvl-head">
                    <span>NÃ­vel ${i}</span>
                    <div class="slots-config">
                        <span class="label-xs">Slots:</span>
                        <input type="number" id="slotsTotal${i}" class="slot-input-sm" value="0" min="0" max="9" onchange="updateSlots(${i})">
                        <div class="slot-bubbles" id="slotsBubbles${i}"></div>
                    </div>
                </div>
                <div class="spell-list" id="spellList${i}">${Array(i<3?7:5).fill(0).map((_,k)=>renderSpellRow(i,k)).join('')}</div>
                <button class="btn-sm" onclick="addSpellRow(${i})">+ Adicionar</button>
            </div>`;
        }
    }
    
    function renderSpellRow(lvl, idx) {
        return `<div class="spell-row" id="row_${lvl}_${idx}"><div class="marker" id="prep_${lvl}_${idx}" data-val="0" onclick="toggleMarker(this, 1)" style="width:8px; height:8px; margin-right:5px;"></div><input id="spell_${lvl}_${idx}" style="font-size:11px;"></div>`;
    }

    function updateSlots(lvl) {
        const total = parseInt(document.getElementById(`slotsTotal${lvl}`).value) || 0;
        const container = document.getElementById(`slotsBubbles${lvl}`);
        
        // Preserve state if possible
        const currentUsed = [];
        container.querySelectorAll('.slot-bubble').forEach((el, idx) => {
            if(el.classList.contains('used')) currentUsed.push(idx);
        });

        container.innerHTML = '';
        for(let i=0; i<total; i++) {
            const bubble = document.createElement('div');
            bubble.className = `slot-bubble ${currentUsed.includes(i) ? 'used' : ''}`;
            bubble.id = `slot_${lvl}_${i}`; 
            bubble.onclick = function() { this.classList.toggle('used'); saveLocal(); };
            container.appendChild(bubble);
        }
        saveLocal();
    }

    function addSpellRow(lvl) {
        const list = document.getElementById(`spellList${lvl}`);
        const div = document.createElement('div');
        div.innerHTML = renderSpellRow(lvl, list.children.length);
        list.appendChild(div.firstChild);
        saveLocal();
    }
    
    function addAtkRow(idxOverride) {
        const tbody = document.getElementById('atkRows');
        const i = (typeof idxOverride === 'number') ? idxOverride : tbody.children.length;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="atk-input" id="atkN${i}"></td><td><input class="atk-input" id="atkB${i}" style="text-align:center;"></td><td><input class="atk-input" id="atkD${i}"></td>`;
        tbody.appendChild(tr);
        if(typeof idxOverride !== 'number') saveLocal();
    }

    function getMod(sc) { return Math.floor((sc - 10) / 2); }
    function fmt(n) { return n >= 0 ? "+" + n : n; }

    function toggleManual(id) {
        const el = document.getElementById(id);
        if(el.value === "") {
            el.classList.remove('manual-override');
            el.dataset.manual = "false";
            recalc();
        } else {
            el.classList.add('manual-override');
            el.dataset.manual = "true";
        }
    }

    function recalc() {
        // PB: Soma todos os nÃºmeros encontrados no campo (Multiclasse)
        const lvlStr = document.getElementById('classLevel').value || "";
        const matches = lvlStr.match(/\d+/g);
        let lvl = 0;
        if (matches) {
            matches.forEach(m => lvl += parseInt(m));
        }
        if (lvl === 0) lvl = 1;

        let pb = 2;
        if(lvl >= 5) pb = 3; if(lvl >= 9) pb = 4; if(lvl >= 13) pb = 5; if(lvl >= 17) pb = 6;
        document.getElementById('profBonus').innerText = fmt(pb);

        let mods = {};
        attrs.forEach(a => {
            const sc = parseInt(document.getElementById('score_'+a).value) || 10;
            const mod = getMod(sc);
            mods[a] = mod;
            document.getElementById('mod_'+a).innerText = fmt(mod);
        });

        attrs.forEach(a => {
            const prof = parseInt(document.getElementById('save_'+a).dataset.val);
            const val = mods[a] + (prof * pb);
            document.getElementById('saveVal_'+a).innerText = fmt(val);
        });

        skills.forEach(s => {
            const prof = parseInt(document.getElementById('skill_'+s.id).dataset.val);
            let bonus = 0; 
            if(prof === 1) bonus = pb;
            if(prof === 2) bonus = pb * 2;
            document.getElementById('skillVal_'+s.id).innerText = fmt(mods[s.at] + bonus);
        });

        const pProf = parseInt(document.getElementById('skill_percep').dataset.val);
        let pBonus = 0; if(pProf===1) pBonus=pb; if(pProf===2) pBonus=pb*2;
        document.getElementById('passivePerc').innerText = 10 + mods['wis'] + pBonus;

        const initEl = document.getElementById('init');
        if(initEl.dataset.manual !== "true") {
            initEl.value = mods['dex'];
        }

        const sa = document.getElementById('spellAbility').value;
        const dcVal = 8 + pb + mods[sa];
        const atkVal = pb + mods[sa];
        
        const dcEl = document.getElementById('spellDC');
        if (dcEl.dataset.manual !== "true") { dcEl.value = dcVal; dcEl.classList.remove('manual-override'); }
        
        const atkEl = document.getElementById('spellAtk');
        if (atkEl.dataset.manual !== "true") { atkEl.value = atkVal; atkEl.classList.remove('manual-override'); }
    }

    function showPage(pid) {
        document.querySelectorAll('.sheet').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        const idx = pid==='page1'?0:(pid==='page2'?1:2);
        document.querySelectorAll('.tab-btn')[idx].classList.add('active');
    }

    function toggleMarker(el, max) {
        let v = parseInt(el.dataset.val);
        v++; if(v > max) v = 0;
        el.dataset.val = v;
        recalc();
        saveLocal();
    }
    
    function uploadImage(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const res = e.target.result;
            const container = document.getElementById('charImageContainer');
            container.style.backgroundImage = `url(${res})`;
            document.getElementById('imgPlaceholder').style.display = 'none';
            saveLocal(res);
        };
        reader.readAsDataURL(file);
    }

    function setupEvents() {
        document.querySelectorAll('input, textarea, select').forEach(el => {
            el.addEventListener('input', () => {
                if(el.classList.contains('sync-name')) {
                    document.querySelectorAll('.sync-name').forEach(x => x.value = el.value);
                }
                if(el.id.includes('score_') || el.id === 'classLevel' || el.id === 'spellAbility') recalc();
                saveLocal();
            });
        });
    }

    function saveLocal(imgDataOverride) {
        const data = { vals: {}, markers: {}, slots: [], charImage: null, manual: {} };
        document.querySelectorAll('input, textarea, select').forEach(el => { 
            if(el.id && el.id !== 'fileUp' && el.id !== 'imgInput') data.vals[el.id] = el.value; 
        });
        document.querySelectorAll('.marker').forEach(el => { if(el.id) data.markers[el.id] = el.dataset.val; });
        document.querySelectorAll('.slot-bubble.used').forEach(el => data.slots.push(el.id));
        
        if(document.getElementById('spellDC').dataset.manual === "true") data.manual['spellDC'] = true;
        if(document.getElementById('spellAtk').dataset.manual === "true") data.manual['spellAtk'] = true;
        if(document.getElementById('init').dataset.manual === "true") data.manual['init'] = true;

        if (imgDataOverride) {
            data.charImage = imgDataOverride;
        } else {
            const container = document.getElementById('charImageContainer');
            const bg = container.style.backgroundImage;
            if(bg && bg.startsWith('url')) data.charImage = bg.slice(5, -2);
        }

        localStorage.setItem('dndSheetOfficial', JSON.stringify(data));
    }
    
    function manualSave() { saveLocal(); alert("Ficha salva no navegador com sucesso!"); }

    function loadLocal() {
        const d = localStorage.getItem('dndSheetOfficial');
        if(d) applyData(JSON.parse(d));
    }
    
    function applyData(d) {
        if(!d) return;
        
        // Dynamic Rows
        let maxSpells = {}; let maxAtk = 4;
        const allKeys = [...Object.keys(d.vals || {}), ...Object.keys(d.markers || {})];
        allKeys.forEach(k => {
            const spellMatch = k.match(/_(?:spell|prep)_(\d+)_(\d+)/);
            if(spellMatch || k.startsWith('spell_') || k.startsWith('prep_')) {
                const parts = k.split('_');
                if(parts.length === 3 && (parts[0]==='spell' || parts[0]==='prep')) {
                    const l = parseInt(parts[1]);
                    const i = parseInt(parts[2]);
                    if(!maxSpells[l] || i > maxSpells[l]) maxSpells[l] = i;
                }
            }
            const atkMatch = k.match(/atk[NBD](\d+)/);
            if(atkMatch) { const i = parseInt(atkMatch[1]); if(i > maxAtk) maxAtk = i; }
        });

        const currentAtks = document.getElementById('atkRows').children.length;
        for(let i=currentAtks; i <= maxAtk; i++) { addAtkRow(i); }

        for(let l=0; l<=9; l++) {
            if(maxSpells[l] !== undefined) {
                const list = document.getElementById(`spellList${l}`);
                const currentCount = list.children.length;
                for(let i=currentCount; i <= maxSpells[l]; i++) {
                    const div = document.createElement('div');
                    div.innerHTML = renderSpellRow(l, i);
                    list.appendChild(div.firstChild);
                }
            }
        }

        // Fill Data
        for(let k in d.vals) { const el=document.getElementById(k); if(el) el.value=d.vals[k]; }
        
        // Re-generate bubbles based on loaded slot totals
        for(let i=1; i<=9; i++) { updateSlots(i); }

        for(let k in d.markers) { const el=document.getElementById(k); if(el) el.dataset.val=d.markers[k]; }
        document.querySelectorAll('.slot-bubble').forEach(e => e.classList.remove('used'));
        if(d.slots) d.slots.forEach(id => { const el=document.getElementById(id); if(el) el.classList.add('used'); });
        
        if(d.manual) {
            ['spellDC', 'spellAtk', 'init'].forEach(id => {
                if(d.manual[id]) {
                    const el = document.getElementById(id);
                    el.dataset.manual = "true";
                    el.classList.add('manual-override');
                }
            });
        }

        if(d.charImage) {
            const container = document.getElementById('charImageContainer');
            container.style.backgroundImage = `url(${d.charImage})`;
            document.getElementById('imgPlaceholder').style.display = 'none';
        }

        recalc();
    }
    
    function saveJSON() {
        saveLocal();
        const d = localStorage.getItem('dndSheetOfficial');
        const n = document.getElementById('charName').value || 'Personagem';
        const b = new Blob([d], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = n+'.json'; a.click();
    }
    function loadJSON(inp) {
        const f = inp.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = e => { applyData(JSON.parse(e.target.result)); saveLocal(); alert('Carregado!'); };
        r.readAsText(f);
    }

    function resetShort() { if(confirm("Descanso Curto: Recuperar Magias de Bruxo e Habilidades?")) { saveLocal(); } }
    
    function resetLong() {
        if(confirm("Descanso Longo: Recuperar PV, Slots e Metade dos DV?")) {
            const max = document.getElementById('hpMax').value;
            if(max) document.getElementById('hpCurrent').value = max;
            document.getElementById('hpTemp').value = '';
            
            document.querySelectorAll('.slot-bubble').forEach(e => e.classList.remove('used'));
            
            const hdTotalStr = document.getElementById('hdTotal').value;
            const hdCurrentEl = document.getElementById('hdCurrent');
            
            const hdMatch = hdTotalStr.match(/(\d+)/);
            if(hdMatch) {
                const total = parseInt(hdMatch[1]);
                let current = parseInt(hdCurrentEl.value) || 0;
                const recover = Math.max(1, Math.floor(total / 2));
                current += recover;
                if(current > total) current = total;
                hdCurrentEl.value = current;
            } else if (hdTotalStr) {
                const total = parseInt(hdTotalStr);
                if(!isNaN(total)) {
                    let current = parseInt(hdCurrentEl.value) || 0;
                    current += Math.max(1, Math.floor(total / 2));
                    if(current > total) current = total;
                    hdCurrentEl.value = current;
                }
            }
            saveLocal();
        }
    }
</script>

</body>
</html>
